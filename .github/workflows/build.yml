name: build
on: [workflow_dispatch]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: 'recursive'

    - name: Install Dependencies
      run: |
        choco install ninja

    - name: Download Skia
      shell: pwsh
      run: |
        $url = "https://github.com/aseprite/skia/releases/download/m124-08a5439a6b/Skia-Windows-Release-x64.zip"
        Invoke-WebRequest -Uri $url -OutFile skia.zip -UserAgent "NativeHost"
        Expand-Archive -Path skia.zip -DestinationPath skia -Force

    - name: Configure & Build (MSVC)
      shell: cmd
      run: |
        call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\Tools\VsDevCmd.bat" -arch=x64

        mkdir build
        cd build

        cmake -G Ninja ^
          -DCMAKE_BUILD_TYPE=Release ^
          -DLAF_BACKEND=skia ^
          -DSKIA_DIR="%CD%\..\skia" ^
          -DSKIA_LIBRARY_DIR="%CD%\..\skia\out\Release-x64" ^
          -DSKIA_LIBRARY="%CD%\..\skia\out\Release-x64\skia.lib" ^
          ..

        ninja aseprite

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: aseprite-windows
        path: |
          build/bin/aseprite.exe
          build/bin/data
